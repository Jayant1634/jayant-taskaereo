{% extends 'tasks/base.html' %}

{% block content %}
{% csrf_token %}
<div class="container-fluid py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="mb-0"><i class="fas fa-clipboard-list me-2 text-primary"></i>My Tasks</h2>
            <p class="text-muted mt-1 mb-0">Manage your tasks efficiently</p>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="fas fa-plus me-2"></i>Add New Task
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0 search-bar">
                <div class="card-body p-3">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" class="form-control border-start-0" id="searchInput" placeholder="Search by title...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-calendar text-muted"></i></span>
                                <input type="date" class="form-control border-start-0" id="searchDate">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="sortByDate">
                                <option value="">Sort by date...</option>
                                <option value="true">Newest First</option>
                                <option value="false">Oldest First</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary w-100" id="clearFilters">
                                <i class="fas fa-times me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="taskList">
        {% for task in tasks %}
        <div class="col-md-6 col-lg-4 task-card mb-4">
            <div class="card h-100 shadow-sm border-0 hover-shadow">
                <div class="card-body">
                    <h5 class="card-title text-truncate">{{ task.title }}</h5>
                    <p class="card-text">{{ task.description }}</p>
                    <div class="text-muted small mb-3">
                        <i class="fas fa-clock me-1"></i> Created: {{ task.created_date|date:"M d, Y H:i" }}
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-auto">
                        <button class="btn btn-sm btn-outline-primary edit-task" data-id="{{ task.id }}"
                                data-bs-toggle="modal" data-bs-target="#editTaskModal">
                            <i class="fas fa-edit me-1"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-task" data-id="{{ task.id }}">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info shadow-sm border-0">
                <i class="fas fa-info-circle me-2"></i>No tasks found. Create your first task by clicking the "Add New Task" button.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2 text-primary"></i>Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTask">
                    <i class="fas fa-save me-1"></i> Save Task
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-edit me-2 text-primary"></i>Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateTask">
                    <i class="fas fa-save me-1"></i> Update Task
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<style>
.hover-shadow:hover {
    transform: translateY(-4px);
    transition: transform 0.3s ease;
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
}
.card {
    transition: all 0.3s ease;
    border-radius: 0.5rem;
}
.btn {
    border-radius: 0.25rem;
}
.form-control, .form-select {
    border-radius: 0.25rem;
}
.form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
}
</style>

<script>
// Use a variable to track if the form has been initialized
var formInitialized = false;

$(document).ready(function() {
    // Prevent double initialization
    if (formInitialized) {
        console.log("Form already initialized, skipping");
        return;
    }
    
    formInitialized = true;
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let isSubmitting = false;  // Flag to prevent double submission
    let submissionCount = 0;   // Debug counter
    let debounceTimer;         // For search debouncing
    
    console.log("Task form initialized");

    // Remove any existing event handlers from previous initializations
    $('#addTaskForm').off('submit');
    $('#saveTask').off('click');
    
    // Prevent any form submission
    $('#addTaskForm').on('submit', function(e) {
        console.log("Form submission prevented");
        e.preventDefault();
        e.stopPropagation();  // Stop event propagation
        return false;
    });

    // Initialize search functionality with debounce
    function debounce(func, delay) {
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Apply filters using AJAX instead of page refresh
    function applyFilters() {
        // Show loading indicator
        $('#loading-indicator').addClass('active');
        
        const searchValue = $('#searchInput').val().trim();
        const searchDate = $('#searchDate').val();
        const sortByDate = $('#sortByDate').val();
        
        // Build query string for history
        const searchParams = new URLSearchParams();
        if (searchValue) searchParams.set('search', searchValue);
        if (searchDate) searchParams.set('search_date', searchDate);
        if (sortByDate) searchParams.set('sort_by_date', sortByDate);
        
        // Update URL without refresh
        const newUrl = window.location.pathname + (searchParams.toString() ? '?' + searchParams.toString() : '');
        history.pushState({ url: newUrl }, '', newUrl);
        
        // Fetch filtered tasks via AJAX
        $.ajax({
            url: '/api/tasks/',
            data: {
                search: searchValue,
                search_date: searchDate,
                sort_by_date: sortByDate
            },
            type: 'GET',
            success: function(data) {
                updateTaskList(data);
            },
            error: function(xhr, status, error) {
                console.error('Error fetching tasks:', error);
                $('#taskList').html(
                    `<div class="col-12">
                        <div class="alert alert-danger shadow-sm border-0">
                            <i class="fas fa-exclamation-circle me-2"></i>Error loading tasks. Please try again.
                        </div>
                    </div>`
                );
            },
            complete: function() {
                $('#loading-indicator').removeClass('active');
            }
        });
    }
    
    // Update task list with fetched data
    function updateTaskList(data) {
        if (!data || !data.length) {
            // No tasks found
            $('#taskList').html(
                `<div class="col-12">
                    <div class="alert alert-info shadow-sm border-0">
                        <i class="fas fa-info-circle me-2"></i>No tasks found matching your criteria.
                    </div>
                </div>`
            );
            return;
        }
        
        // Clear current tasks with fade out
        $('#taskList').css('opacity', 0);
        
        // Build new task HTML
        let taskHtml = '';
        data.forEach(function(task) {
            const createdDate = new Date(task.created_date).toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric'
            });
            
            taskHtml += `
                <div class="col-md-6 col-lg-4 task-card mb-4">
                    <div class="card h-100 shadow-sm border-0 hover-shadow">
                        <div class="card-body">
                            <h5 class="card-title text-truncate">${task.title}</h5>
                            <p class="card-text">${task.description}</p>
                            <div class="text-muted small mb-3">
                                <i class="fas fa-clock me-1"></i> Created: ${createdDate}
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-auto">
                                <button class="btn btn-sm btn-outline-primary edit-task" 
                                        data-id="${task.id}" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editTaskModal"
                                        data-bs-toggle="tooltip" 
                                        title="Edit this task">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-task" 
                                        data-id="${task.id}"
                                        data-bs-toggle="tooltip" 
                                        title="Delete this task">
                                    <i class="fas fa-trash me-1"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Update DOM and fade in
        $('#taskList').html(taskHtml);
        
        // Reinitialize event handlers
        initializeTaskEvents();
        
        // Fade in with staggered animation
        $('#taskList').css('opacity', 1);
        $('.task-card').each(function(index) {
            $(this).addClass('fade-in');
            $(this).css('animation-delay', (index * 0.1) + 's');
        });
        
        // Reinitialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function(tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl, {
                delay: { show: 500, hide: 100 }
            });
        });
    }
    
    // Initialize event handlers for dynamically created task elements
    function initializeTaskEvents() {
        // Edit Task
        $('.edit-task').off('click').on('click', function() {
            const taskId = $(this).data('id');
            
            // Show loading effect in the modal
            $('#editTaskModal .modal-content').css('opacity', 0.7);
            $('#editTaskModal .modal-body').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading task...</p></div>');
            
            $.ajax({
                url: '/api/tasks/' + taskId + '/',
                type: 'GET',
                success: function(task) {
                    // Populate the form with task data
                    const modalContent = `
                        <form id="editTaskForm">
                            <input type="hidden" id="editTaskId" value="${task.id}">
                            <div class="mb-3">
                                <label for="editTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="editTitle" name="title" value="${task.title}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="editDescription" name="description" rows="3" required>${task.description}</textarea>
                            </div>
                        </form>
                    `;
                    
                    $('#editTaskModal .modal-body').html(modalContent);
                    $('#editTaskModal .modal-content').css('opacity', 1);
                },
                error: function(xhr, status, error) {
                    console.error('Error details:', {xhr, status, error});
                    $('#editTaskModal .modal-body').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>Error loading task: ${error}
                        </div>
                    `);
                    $('#editTaskModal .modal-content').css('opacity', 1);
                }
            });
        });

        // Delete Task
        $('.delete-task').off('click').on('click', function() {
            if (confirm('Are you sure you want to delete this task?')) {
                if (isSubmitting) return;  // Prevent double submission
                isSubmitting = true;
                const $button = $(this);
                $button.prop('disabled', true);
                $button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

                const taskId = $(this).data('id');
                $.ajax({
                    url: '/api/tasks/' + taskId + '/',
                    type: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    success: function() {
                        // Remove the task card with animation
                        $button.closest('.task-card').fadeOut(300, function() {
                            $(this).remove();
                            // Check if there are no tasks left
                            if ($('.task-card').length === 0) {
                                $('#taskList').html(`
                                    <div class="col-12">
                                        <div class="alert alert-info shadow-sm border-0">
                                            <i class="fas fa-info-circle me-2"></i>No tasks found. Create your first task by clicking the "Add New Task" button.
                                        </div>
                                    </div>
                                `);
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error details:', {xhr, status, error});
                        alert('Error deleting task: ' + error);
                        $button.html('<i class="fas fa-trash me-1"></i> Delete');
                    },
                    complete: function() {
                        isSubmitting = false;
                        $button.prop('disabled', false);
                    }
                });
            }
        });
    }

    // Handle real-time search
    $('#searchInput').on('input', debounce(function() {
        applyFilters();
    }, 500));

    // Handle date selection
    $('#searchDate').on('change', function() {
        applyFilters();
    });

    // Handle sort selection
    $('#sortByDate').on('change', function() {
        applyFilters();
    });

    // Clear all filters
    $('#clearFilters').on('click', function() {
        $('#searchInput').val('');
        $('#searchDate').val('');
        $('#sortByDate').val('');
        applyFilters();
    });

    // Initialize filters from URL
    const urlParams = new URLSearchParams(window.location.search);
    $('#searchInput').val(urlParams.get('search') || '');
    $('#searchDate').val(urlParams.get('search_date') || '');
    $('#sortByDate').val(urlParams.get('sort_by_date') || '');
    
    // If we have filter parameters, load content immediately
    if (urlParams.toString()) {
        applyFilters();
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl, {
            delay: { show: 500, hide: 100 }
        });
    });
    
    // Initial setup for task events
    initializeTaskEvents();

    // Add Task
    $('#saveTask').on('click', function(e) {
        console.log("Save button clicked");
        e.preventDefault();  // Prevent default action
        e.stopPropagation(); // Stop event propagation
        
        if (isSubmitting) {
            console.log("Already submitting, preventing duplicate");
            return false;
        }
        
        const title = $('#title').val().trim();
        const description = $('#description').val().trim();
        
        if (!title || !description) {
            // Show validation error with animation
            const $errorMsg = $('<div class="alert alert-danger mt-3 fade-in">Please fill in all required fields</div>');
            $('#addTaskForm').append($errorMsg);
            setTimeout(() => $errorMsg.fadeOut(500, function() { $(this).remove(); }), 3000);
            return false;
        }

        isSubmitting = true;
        submissionCount++;
        const currentSubmission = submissionCount;
        console.log(`Starting submission #${currentSubmission}`);
        
        // Show loading indicator in the button
        const $button = $(this);
        $button.prop('disabled', true)
               .html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...');

        const formData = {
            title: title,
            description: description
        };

        // Disable all buttons and form fields during submission
        $('.modal-content button').prop('disabled', true);
        $('#title, #description').prop('disabled', true);

        // Use a unique ID for each request based on timestamp to ensure no duplicates
        const uniqueId = new Date().getTime() + '-' + Math.random().toString(36).substr(2, 9);
        
        // Show the loading indicator
        $('#loading-indicator').addClass('active');
        
        $.ajax({
            url: '/api/tasks/?_=' + uniqueId + '&submission=' + currentSubmission,
            type: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Submission-ID': currentSubmission.toString(),
                'X-Request-ID': uniqueId
            },
            data: JSON.stringify(formData),
            processData: false,
            success: function(response) {
                console.log(`Submission #${currentSubmission} successful`);
                
                // Hide the modal
                const modal = bootstrap.Modal.getInstance($('#addTaskModal'));
                modal.hide();
                
                // Reset the form
                $('#addTaskForm')[0].reset();
                
                // Add the new task to the UI with animation
                const taskCard = createTaskCard(response);
                
                if ($('#taskList .alert').length > 0) {
                    // Replace "no tasks" message with the new task
                    $('#taskList').html(taskCard);
                } else {
                    // Prepend the new task to the list
                    $('#taskList').prepend(taskCard);
                }
                
                // Apply animations and initialize event handlers
                const $newCard = $('#taskList .task-card').first();
                $newCard.hide().fadeIn(500);
                initializeTaskEvents();
                
                // Show success message
                showToast('Task created successfully!', 'success');
            },
            error: function(xhr, status, error) {
                console.error(`Submission #${currentSubmission} failed:`, {xhr, status, error});
                
                // If it's a 429 error (too many requests), it means a duplicate was prevented
                if (xhr.status === 429) {
                    console.log("Duplicate submission detected, refreshing task list");
                    applyFilters(); // Refresh the task list
                    
                    // Hide the modal
                    const modal = bootstrap.Modal.getInstance($('#addTaskModal'));
                    modal.hide();
                    
                    // Reset the form
                    $('#addTaskForm')[0].reset();
                    
                    return;
                }
                
                let errorMessage = 'Error creating task';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.detail || response.message || errorMessage;
                } catch (e) {
                    errorMessage = xhr.responseText || errorMessage;
                }
                
                // Show error in the form
                const $errorMsg = $('<div class="alert alert-danger mt-3 fade-in">' + errorMessage + '</div>');
                $('#addTaskForm').append($errorMsg);
                setTimeout(() => $errorMsg.fadeOut(500, function() { $(this).remove(); }), 4000);
            },
            complete: function() {
                console.log(`Submission #${currentSubmission} completed`);
                isSubmitting = false;
                
                // Reset the button
                $button.prop('disabled', false)
                       .html('<i class="fas fa-save me-1"></i> Save Task');
                
                // Re-enable all buttons and form fields
                $('.modal-content button').prop('disabled', false);
                $('#title, #description').prop('disabled', false);
                
                // Hide the loading indicator
                $('#loading-indicator').removeClass('active');
            }
        });
        
        return false; // Prevent any default action or bubbling
    });
    
    // Function to create a task card HTML
    function createTaskCard(task) {
        const createdDate = new Date(task.created_date).toLocaleString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric'
        });
        
        return `
            <div class="col-md-6 col-lg-4 task-card mb-4">
                <div class="card h-100 shadow-sm border-0 hover-shadow">
                    <div class="card-body">
                        <h5 class="card-title text-truncate">${task.title}</h5>
                        <p class="card-text">${task.description}</p>
                        <div class="text-muted small mb-3">
                            <i class="fas fa-clock me-1"></i> Created: ${createdDate}
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-auto">
                            <button class="btn btn-sm btn-outline-primary edit-task" 
                                    data-id="${task.id}" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editTaskModal"
                                    data-bs-toggle="tooltip" 
                                    title="Edit this task">
                                <i class="fas fa-edit me-1"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-task" 
                                    data-id="${task.id}"
                                    data-bs-toggle="tooltip" 
                                    title="Delete this task">
                                <i class="fas fa-trash me-1"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Update Task handler
    $('#updateTask').on('click', function() {
        if (isSubmitting) return;
        isSubmitting = true;
        
        // Add loading spinner to button
        const $button = $(this);
        $button.prop('disabled', true)
               .html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Updating...');

        const taskId = $('#editTaskId').val();
        const formData = {
            title: $('#editTitle').val().trim(),
            description: $('#editDescription').val().trim()
        };
        
        // Show the loading indicator
        $('#loading-indicator').addClass('active');

        $.ajax({
            url: '/api/tasks/' + taskId + '/',
            type: 'PATCH',
            headers: {
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(formData),
            processData: false,
            success: function(response) {
                // Hide the modal
                const modal = bootstrap.Modal.getInstance($('#editTaskModal'));
                modal.hide();
                
                // Update the task in the UI
                const $taskCard = $(`.task-card .edit-task[data-id="${taskId}"]`).closest('.task-card');
                const createdDate = new Date(response.created_date).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric'
                });
                
                // Update card with highlight animation
                $taskCard.find('.card-title').text(response.title);
                $taskCard.find('.card-text').text(response.description);
                
                // Highlight the updated card
                $taskCard.find('.card').addClass('border-primary');
                setTimeout(() => $taskCard.find('.card').removeClass('border-primary'), 2000);
                
                // Show success message
                showToast('Task updated successfully!', 'success');
            },
            error: function(xhr, status, error) {
                console.error('Error details:', {xhr, status, error});
                
                let errorMessage = 'Error updating task';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.detail || response.message || errorMessage;
                } catch (e) {
                    errorMessage = xhr.responseText || errorMessage;
                }
                
                // Show error in the modal
                const $errorMsg = $('<div class="alert alert-danger mt-3 fade-in">' + errorMessage + '</div>');
                $('#editTaskForm').append($errorMsg);
                setTimeout(() => $errorMsg.fadeOut(500, function() { $(this).remove(); }), 4000);
            },
            complete: function() {
                isSubmitting = false;
                
                // Reset the button
                $button.prop('disabled', false)
                       .html('<i class="fas fa-save me-1"></i> Update Task');
                
                // Hide the loading indicator
                $('#loading-indicator').removeClass('active');
            }
        });
    });
    
    // Toast notification function
    function showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        if ($('#toast-container').length === 0) {
            $('body').append('<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>');
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Add toast to container
        $('#toast-container').append(toastHtml);
        
        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
        toast.show();
    }
});
</script>
{% endblock %}
{% endblock %}
